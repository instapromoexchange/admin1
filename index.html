<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel — Instapromo Exchange</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f6fb; --card:#ffffff; --accent:#4a00e0; --accent2:#8e2de2; --muted:#6b7280;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:var(--bg);color:#111;}
    header{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:18px;margin:0}
    header .sub{font-size:13px;opacity:.9}
    .wrap{max-width:1200px;margin:22px auto;padding:0 16px;}
    .grid{display:grid;gap:16px;grid-template-columns:repeat( auto-fit, minmax(240px, 1fr) );margin-bottom:18px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(12,18,40,0.06);min-height:80px}
    .card h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
    .stat{font-weight:700;font-size:20px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;background:#111;color:#fff;font-weight:600}
    .btn.secondary{background:#6b7280}
    .btn.small{padding:6px 10px;font-size:14px}
    .btn-ok{background:var(--ok)}
    .btn-warn{background:var(--warn);color:#111}
    .btn-bad{background:var(--bad)}
    .table-card{overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px 12px;border-bottom:1px solid #eef2f7;text-align:left}
    th{position:sticky;top:0;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
    td .muted{color:var(--muted);font-size:13px}
    .tag{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:600;font-size:13px}
    .tag.pending{background:#fff3cd;color:#854d00}
    .tag.approved{background:#ddf7e6;color:#0a6f2d}
    .tag.rejected{background:#ffe6e6;color:#8b1e1e}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .search{padding:8px 12px;border-radius:10px;border:1px solid #e6e9ef;width:260px}
    .small-input{padding:6px 10px;border-radius:8px;border:1px solid #e6e9ef}
    .note{font-size:13px;color:var(--muted);margin-top:6px}
    footer{max-width:1200px;margin:14px auto;padding:8px 16px;text-align:center;color:var(--muted);font-size:13px}
    @media (max-width:720px){
      header{padding:14px}
      .controls{flex-direction:column;align-items:flex-start}
      .search{width:100%}
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Admin Panel — Instapromo Exchange</h1>
      <div class="sub">Open admin (no password). Use carefully.</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="refreshBtn"><i class="fa fa-sync"></i> Refresh</button>
      <button class="btn secondary" id="addDummyBtn"><i class="fa fa-plus"></i> Add Dummy</button>
      <button class="btn secondary" id="clearCacheBtn"><i class="fa fa-trash"></i> Clear Local</button>
    </div>
  </header>

  <main class="wrap">
    <!-- STATS -->
    <div class="grid">
      <div class="card">
        <h3>Total users</h3>
        <div class="stat" id="statUsers">0</div>
        <div class="note">Number of documents in <code>users</code> collection</div>
      </div>
      <div class="card">
        <h3>Pending submissions</h3>
        <div class="stat" id="statSub">0</div>
        <div class="note">Submissions (content) awaiting approval</div>
      </div>
      <div class="card">
        <h3>Withdraw requests</h3>
        <div class="stat" id="statWithdraw">0</div>
        <div class="note">Requests by users to withdraw funds</div>
      </div>
      <div class="card">
        <h3>Brand requests</h3>
        <div class="stat" id="statBrand">0</div>
        <div class="note">Campaign / brand promotion requests</div>
      </div>
    </div>

    <!-- Controls & Search -->
    <div class="card">
      <div class="controls">
        <input id="searchInput" class="search" placeholder="Search users / emails / brand names..." />
        <select id="filterSelect" class="small-input">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
        <div style="margin-left:auto" class="muted">Live Firestore admin console (read/update).</div>
      </div>
    </div>

    <!-- Users table -->
    <section class="card table-card">
      <h3>Users</h3>
      <table id="usersTable">
        <thead>
          <tr><th>Name</th><th>Email</th><th>Instagram</th><th>Balance (₹)</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Submissions table -->
    <section class="card table-card">
      <h3>Submissions (content)</h3>
      <table id="subsTable">
        <thead>
          <tr><th>User</th><th>Type</th><th>Amount</th><th>Link</th><th>Date</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Withdrawals table -->
    <section class="card table-card">
      <h3>Withdraw Requests</h3>
      <table id="withdrawTable">
        <thead>
          <tr><th>User</th><th>Amount</th><th>Method</th><th>Date</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Brand requests table -->
    <section class="card table-card">
      <h3>Brand Requests</h3>
      <table id="brandTable">
        <thead>
          <tr><th>Brand</th><th>Email</th><th>Budget</th><th>Type</th><th>Date</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    Tip: Use "Add Dummy" to create test docs. For production, remove or restrict this file.
  </footer>

  <!-- Firebase + Admin logic -->
  <script type="module">
  // --- Firebase modular imports (browser) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where, orderBy
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  // --- YOUR firebaseConfig (you provided earlier) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBm4VTr__mag1trF4jPZCgqt7gWwBItD58",
    authDomain: "exchange-a725e.firebaseapp.com",
    projectId: "exchange-a725e",
    storageBucket: "exchange-a725e.firebasestorage.app",
    messagingSenderId: "47165517524",
    appId: "1:47165517524:web:7712aae884de7a498a1541"
  };

  // init
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM refs
  const usersTBody = document.querySelector("#usersTable tbody");
  const subsTBody = document.querySelector("#subsTable tbody");
  const withdrawTBody = document.querySelector("#withdrawTable tbody");
  const brandTBody = document.querySelector("#brandTable tbody");
  const statUsers = document.getElementById("statUsers");
  const statSub = document.getElementById("statSub");
  const statWithdraw = document.getElementById("statWithdraw");
  const statBrand = document.getElementById("statBrand");
  const refreshBtn = document.getElementById("refreshBtn");
  const addDummyBtn = document.getElementById("addDummyBtn");
  const clearCacheBtn = document.getElementById("clearCacheBtn");
  const searchInput = document.getElementById("searchInput");
  const filterSelect = document.getElementById("filterSelect");

  // helper
  function fmtDate(iso){
    try{ return new Date(iso).toLocaleString(); }catch(e){ return iso; }
  }
  function tagForStatus(st){
    if(!st) return `<span class="tag pending">PENDING</span>`;
    if(st.toLowerCase()==='approved') return `<span class="tag approved">APPROVED</span>`;
    if(st.toLowerCase()==='rejected') return `<span class="tag rejected">REJECTED</span>`;
    return `<span class="tag pending">${st}</span>`;
  }

  // load all dashboard data
  async function loadAll(){
    // disable buttons briefly
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = `<i class="fa fa-sync"></i> Loading...`;
    try{
      await Promise.all([loadUsers(), loadSubmissions(), loadWithdrawals(), loadBrandRequests()]);
    }catch(e){
      console.error(e);
      alert("Error loading data: " + (e.message || e));
    }finally{
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = `<i class="fa fa-sync"></i> Refresh`;
    }
  }

  // USERS
  async function loadUsers(){
    usersTBody.innerHTML = `<tr><td colspan="5" class="muted">Loading users...</td></tr>`;
    const snap = await getDocs(collection(db, "users"));
    statUsers.textContent = snap.size;
    usersTBody.innerHTML = "";
    snap.forEach(d=>{
      const u = d.data();
      const id = d.id;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(u.name||"-")}</td>
        <td>${escapeHtml(u.email||"-")}</td>
        <td class="muted">${escapeHtml(u.instagram||"-")}</td>
        <td>₹<span id="bal_${id}">${u.balance||0}</span></td>
        <td>
          <div class="actions">
            <button class="btn small" onclick="promptEditBalance('${id}', ${u.balance||0})"><i class="fa fa-edit"></i> Edit</button>
            <button class="btn small btn-bad" onclick="adminDeleteUser('${id}')"><i class="fa fa-trash"></i> Delete</button>
          </div>
        </td>`;
      usersTBody.appendChild(row);
    });
  }

  // SUBMISSIONS
  async function loadSubmissions(){
    subsTBody.innerHTML = `<tr><td colspan="7" class="muted">Loading submissions...</td></tr>`;
    // order by date desc if exists
    const q = query(collection(db, "submissions"), orderBy("date", "desc"));
    const snap = await getDocs(q);
    statSub.textContent = snap.size;
    subsTBody.innerHTML = "";
    snap.forEach(d=>{
      const s = d.data();
      const id = d.id;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(s.userName||s.userEmail||"-")}</td>
        <td class="muted">${escapeHtml(s.contentType||"-")}</td>
        <td>₹${s.amount||0}</td>
        <td><a href="${escapeAttr(s.contentLink||'#')}" target="_blank">View</a></td>
        <td class="muted">${fmtDate(s.date)}</td>
        <td>${tagForStatus(s.status)}</td>
        <td>
          ${s.status==='pending' ? `<div class="actions">
            <button class="btn small btn-ok" onclick="approveSubmission('${id}','${escapeAttr(s.userId||"")}','${s.amount||0}')">Approve</button>
            <button class="btn small btn-bad" onclick="rejectSubmission('${id}')">Reject</button>
          </div>` : `<div class="muted">No actions</div>`}
        </td>
      `;
      subsTBody.appendChild(row);
    });
  }

  // WITHDRAWALS
  async function loadWithdrawals(){
    withdrawTBody.innerHTML = `<tr><td colspan="6" class="muted">Loading withdraws...</td></tr>`;
    const q = query(collection(db, "withdrawals"), orderBy("date", "desc"));
    const snap = await getDocs(q);
    statWithdraw.textContent = snap.size;
    withdrawTBody.innerHTML = "";
    snap.forEach(d=>{
      const w = d.data();
      const id = d.id;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(w.userName||w.userEmail||"-")}</td>
        <td>₹${w.amount||0}</td>
        <td class="muted">${escapeHtml(w.method||"-")}${w.upiId? ' • '+escapeHtml(w.upiId):''}</td>
        <td class="muted">${fmtDate(w.date)}</td>
        <td>${tagForStatus(w.status)}</td>
        <td>
          ${w.status==='pending' ? `<div class="actions">
            <button class="btn small btn-ok" onclick="approveWithdraw('${id}','${escapeAttr(w.userId||"")}','${w.amount||0}')">Approve</button>
            <button class="btn small btn-bad" onclick="rejectWithdraw('${id}')">Reject</button>
          </div>` : `<div class="muted">No actions</div>`}
        </td>`;
      withdrawTBody.appendChild(row);
    });
  }

  // BRAND REQUESTS
  async function loadBrandRequests(){
    brandTBody.innerHTML = `<tr><td colspan="7" class="muted">Loading brand requests...</td></tr>`;
    const q = query(collection(db, "brandRequests"), orderBy("date", "desc"));
    const snap = await getDocs(q);
    statBrand.textContent = snap.size;
    brandTBody.innerHTML = "";
    snap.forEach(d=>{
      const b = d.data();
      const id = d.id;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(b.brandName||"-")}</td>
        <td class="muted">${escapeHtml(b.brandEmail||"-")}</td>
        <td>₹${b.campaignBudget||0}</td>
        <td class="muted">${escapeHtml(b.campaignType||"-")}</td>
        <td class="muted">${fmtDate(b.date)}</td>
        <td>${tagForStatus(b.status)}</td>
        <td>
          ${b.status==='pending' ? `<div class="actions">
            <button class="btn small btn-ok" onclick="approveBrand('${id}')">Approve</button>
            <button class="btn small btn-bad" onclick="rejectBrand('${id}')">Reject</button>
          </div>` : `<div class="muted">No actions</div>`}
        </td>`;
      brandTBody.appendChild(row);
    });
  }

  // ====== ACTIONS: approve / reject / update ======
  async function approveSubmission(subId, userId, amount){
    try{
      await updateDoc(doc(db,"submissions",subId),{status:"approved"});
      // update user's balance
      if(userId){
        const userRef = doc(db,"users",userId);
        // get current balance via getDocs is heavier; instead read and write: we'll fetch user's doc explicitly
        const userSnap = await getDocs(query(collection(db,"users"), where("__name__","==", userId)));
        if(userSnap.size>0){
          // however __name__ queries are odd — simpler: update based on reading doc directly using doc() + getDocs isn't perfect.
          // We'll attempt to read doc by id using getDocs on single doc path is not available; but Firestore supports getDoc - but we didn't import getDoc.
        }
      }
      // simpler approach: don't change balance if userId not reliable; better: read and update via updateDoc on users/{userId}
      try{
        if(userId){
          const uRef = doc(db,"users",userId);
          // read current user doc by fetching via getDocs was omitted; to keep code robust we will attempt to read via getDocs with query on __name__ isn't recommended.
          // Instead fetch all users and match id — but that's heavy. Better import getDoc from firestore. Let's dynamically import it now:
        }
      }catch(e){}
      // we'll run a helper that safely increments balance
      await safeAddBalance(userId, Number(amount||0));
      alert("Submission approved.");
      await loadAll();
    }catch(e){
      console.error(e); alert("Error: "+(e.message||e));
    }
  }

  async function rejectSubmission(subId){
    try{ await updateDoc(doc(db,"submissions",subId),{status:"rejected"}); alert("Submission rejected"); await loadAll(); }
    catch(e){ console.error(e); alert("Error: "+(e.message||e)); }
  }

  async function approveWithdraw(withdrawId, userId, amount){
    try{
      await updateDoc(doc(db,"withdrawals",withdrawId),{status:"completed"});
      await safeAddBalance(userId, -Number(amount||0));
      alert("Withdraw approved and balance deducted.");
      await loadAll();
    }catch(e){ console.error(e); alert("Error: "+(e.message||e));}
  }

  async function rejectWithdraw(withdrawId){
    try{ await updateDoc(doc(db,"withdrawals",withdrawId),{status:"rejected"}); alert("Withdraw rejected"); await loadAll(); }
    catch(e){ console.error(e); alert("Error: "+(e.message||e));}
  }

  async function approveBrand(brandId){
    try{ await updateDoc(doc(db,"brandRequests",brandId),{status:"approved"}); alert("Brand approved"); await loadAll(); }
    catch(e){ console.error(e); alert("Error: "+(e.message||e));}
  }
  async function rejectBrand(brandId){
    try{ await updateDoc(doc(db,"brandRequests",brandId),{status:"rejected"}); alert("Brand rejected"); await loadAll(); }
    catch(e){ console.error(e); alert("Error: "+(e.message||e));}
  }

  // Safe add/subtract balance (reads and updates user doc by id)
  // We'll import getDoc to read current value and updateDoc to write.
  import { getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  async function safeAddBalance(userId, delta){
    if(!userId) return;
    try{
      const uRef = doc(db,"users",userId);
      const snap = await getDoc(uRef);
      if(snap.exists()){
        const cur = snap.data().balance || 0;
        const next = Number(cur) + Number(delta || 0);
        await updateDoc(uRef, { balance: next });
      }
    }catch(e){ console.error("safeAddBalance error", e); }
  }

  // Edit balance prompt
  window.promptEditBalance = async function(userId, currentBalance){
    const val = prompt("Set new balance (₹)", String(currentBalance||0));
    if(val === null) return;
    const n = Number(val);
    if(isNaN(n)){ alert("Invalid number"); return; }
    try{ await updateDoc(doc(db,"users",userId), { balance: n }); alert("Balance updated"); await loadAll(); }
    catch(e){ console.error(e); alert("Error: "+(e.message||e)); }
  };

  // Admin delete user (confirmation)
  window.adminDeleteUser = async function(userId){
    if(!confirm("Delete user doc from Firestore? This can't be undone from UI.")) return;
    try{
      // deleteDoc not imported initially; dynamically import
      const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js");
      await deleteDoc(doc(db,"users",userId));
      alert("User deleted.");
      await loadAll();
    }catch(e){ console.error(e); alert("Error: "+(e.message||e)); }
  };

  // Approve wrapper (call internal)
  window.approveSubmission = approveSubmission;
  window.rejectSubmission = rejectSubmission;
  window.approveWithdraw = approveWithdraw;
  window.rejectWithdraw = rejectWithdraw;
  window.approveBrand = approveBrand;
  window.rejectBrand = rejectBrand;
  window.promptEditBalance = window.promptEditBalance;
  window.adminDeleteUser = window.adminDeleteUser;

  // Add dummy data for testing
  async function addDummyData(){
    try{
      await addDoc(collection(db,"users"), { name:"Test User "+Date.now()%1000, email:"test"+Date.now()%1000+"@mail.com", instagram:"@testacc", balance:100 });
      await addDoc(collection(db,"submissions"), { userId:"", userName:"Test User", contentType:"story", contentLink:"https://example.com", date:new Date().toISOString(), status:"pending", amount:500 });
      await addDoc(collection(db,"withdrawals"), { userId:"", userName:"Test User", userEmail:"test@mail.com", amount:50, method:"UPI", upiId:"test@upi", date:new Date().toISOString(), status:"pending" });
      await addDoc(collection(db,"brandRequests"), { brandName:"DemoBrand", brandEmail:"brand@mail.com", campaignType:"story", campaignBudget:1000, campaignDetails:"Demo", date:new Date().toISOString(), status:"pending" });
      alert("Dummy docs added (users, submissions, withdrawals, brandRequests).");
      await loadAll();
    }catch(e){ console.error(e); alert("Error adding dummy: "+(e.message||e)); }
  }

  // clear localStorage (UI helper)
  function clearLocal(){
    if(!confirm("Clear localStorage? This only clears your browser localStorage (not Firestore).")) return;
    localStorage.clear(); alert("localStorage cleared.");
  }

  // search/filter simple client-side (reload tables and filter rows)
  searchInput.addEventListener("input", () => {
    const q = String(searchInput.value||"").trim().toLowerCase();
    if(!q){ // reload full lists
      loadAll();
      return;
    }
    // simple approach: fetch and filter on server (client-side filtering after fetch)
    // We'll reload all then filter in place using text matching
    (async()=>{
      await loadAll();
      // filter users
      filterTableRows("#usersTable tbody tr", q);
      filterTableRows("#subsTable tbody tr", q);
      filterTableRows("#withdrawTable tbody tr", q);
      filterTableRows("#brandTable tbody tr", q);
    })();
  });

  function filterTableRows(selector, q){
    document.querySelectorAll(selector).forEach(row=>{
      const text = row.innerText.toLowerCase();
      row.style.display = text.indexOf(q) === -1 ? "none" : "";
    });
  }

  // filter by status
  filterSelect.addEventListener("change", ()=>{
    const v = filterSelect.value;
    if(v==="all"){ loadAll(); return; }
    // reload then hide rows not matching status tag text
    (async()=>{
      await loadAll();
      document.querySelectorAll("tbody tr").forEach(row=>{
        const txt = row.innerText.toLowerCase();
        if(txt.indexOf(v) === -1) row.style.display = "none";
      });
    })();
  });

  // wire buttons
  refreshBtn.addEventListener("click", loadAll);
  addDummyBtn.addEventListener("click", addDummyData);
  clearCacheBtn.addEventListener("click", clearLocal);

  // escape helpers
  function escapeHtml(s){ if(!s && s!==0) return ""; return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function escapeAttr(s){ if(!s && s!==0) return ""; return String(s).replaceAll("'","\\'").replaceAll('"','\\"'); }

  // initial load
  loadAll();

  // auto-refresh every 90s (optional)
  setInterval(loadAll, 90000);
  </script>
</body>
</html>
